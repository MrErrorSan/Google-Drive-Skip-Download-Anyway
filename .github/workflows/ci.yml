name: CI

on:
  push:
    branches: [ main, develop ]
  pull_request:
    branches: [ main, develop ]

jobs:
  lint:
    name: Lint and Validate
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Setup Node.js
      uses: actions/setup-node@v4
      with:
        node-version: '20'
    
    - name: Validate userscript syntax
      run: |
        echo "Validating userscript files..."
        for file in *.user.js; do
          if [ -f "$file" ]; then
            echo "Checking $file..."
            # Check for required userscript headers
            if ! grep -q "==UserScript==" "$file"; then
              echo "❌ $file: Missing userscript header"
              exit 1
            fi
            if ! grep -q "@name" "$file"; then
              echo "❌ $file: Missing @name directive"
              exit 1
            fi
            if ! grep -q "@match" "$file"; then
              echo "❌ $file: Missing @match directive"
              exit 1
            fi
            echo "✅ $file: Valid userscript format"
          fi
        done
    
    - name: Check file sizes
      run: |
        echo "Checking file sizes..."
        for file in *.user.js; do
          if [ -f "$file" ]; then
            size=$(wc -c < "$file")
            if [ $size -gt 1048576 ]; then
              echo "⚠️  $file: File size is $(($size / 1024))KB (larger than 1MB)"
            else
              echo "✅ $file: File size is $(($size / 1024))KB"
            fi
          fi
        done
    
    - name: Check for console.log statements
      run: |
        echo "Checking for console.log statements (should be minimal)..."
        for file in *.user.js; do
          if [ -f "$file" ]; then
            count=$(grep -c "console.log" "$file" || true)
            if [ $count -gt 10 ]; then
              echo "⚠️  $file: Contains $count console.log statements (consider reducing)"
            else
              echo "✅ $file: Contains $count console.log statements"
            fi
          fi
        done

  validate-readme:
    name: Validate README
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Check README exists
      run: |
        if [ ! -f "README.md" ]; then
          echo "❌ README.md is missing"
          exit 1
        fi
        echo "✅ README.md exists"
    
    - name: Validate README links
      run: |
        echo "Checking README.md for broken links..."
        # Check if raw GitHub links are present
        if ! grep -q "raw.githubusercontent.com" README.md; then
          echo "⚠️  No raw GitHub links found in README"
        else
          echo "✅ Raw GitHub links found in README"
        fi
    
    - name: Check LICENSE file
      run: |
        if [ ! -f "LICENSE" ]; then
          echo "❌ LICENSE file is missing"
          exit 1
        fi
        echo "✅ LICENSE file exists"

  security:
    name: Security Checks
    runs-on: ubuntu-latest
    
    steps:
    - name: Checkout code
      uses: actions/checkout@v5
    
    - name: Check for sensitive data
      run: |
        echo "Checking for potential sensitive data..."
        # Check for API keys, tokens, etc.
        if grep -r -i "api[_-]key\|secret\|password\|token" *.user.js 2>/dev/null; then
          echo "⚠️  Potential sensitive data found. Please review."
        else
          echo "✅ No obvious sensitive data found"
        fi
    
    - name: Check for eval() usage
      run: |
        echo "Checking for potentially unsafe code patterns..."
        for file in *.user.js; do
          if [ -f "$file" ]; then
            if grep -q "eval(" "$file"; then
              echo "⚠️  $file: Contains eval() - review for security"
            else
              echo "✅ $file: No eval() found"
            fi
          fi
        done

